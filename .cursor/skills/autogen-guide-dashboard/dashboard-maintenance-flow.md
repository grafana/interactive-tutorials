# Dashboard Guide Maintenance Flow

Follow this workflow when maintaining or updating an existing guide — not creating one from scratch. The primary skill file (`SKILL.md`) covers fresh generation; this file covers revisiting a guide that was previously generated by this skill.

The key advantage of maintenance mode is that prior analysis files in `assets/` serve as a warm start, reducing redundant work. However, the dashboard may have changed since the guide was last generated, so every reused artifact must be checked for drift.

---

## Prerequisites

Before entering maintenance mode, confirm:

1. The guide directory exists and contains `content.json`
2. The `assets/` subdirectory exists and contains `manifest.yaml`

If either is missing, this is not a maintenance run — follow the full generation pipeline in `SKILL.md`.

---

## Phase 0: Detect Prior Run

Read `{guide_dir}/assets/manifest.yaml`. Extract:

- `dashboard.uid` and `dashboard.source_sha256` — for drift detection
- `guide.sections` — the section IDs from the previous run
- `guide.selector_quality` — the previous selector quality breakdown
- `files` — paths to all analysis artifacts

Present a brief summary to the user:

> "This guide was last generated on {generated_at} from dashboard `{uid}` ({title}). It has {N} sections with {total_steps} interactive steps. Let me check if the dashboard has changed."

---

## Phase 1M: Re-Acquire and Detect Drift

### 1M.1 Fetch the current dashboard JSON

Re-fetch or re-read the dashboard JSON using the same approach as SKILL.md Phase 1.2. Save it to `{guide_dir}/assets/dashboard-source.json` (overwriting the previous snapshot).

### 1M.2 Compute the new SHA-256

```bash
shasum -a 256 {guide_dir}/assets/dashboard-source.json
```

Compare the new hash with `dashboard.source_sha256` from the manifest.

### 1M.3 Branch on drift

**If the hash matches** (no dashboard changes):

> "The dashboard JSON is unchanged since the last run. Skipping re-extraction."

Skip to Phase 4M (review-only run). This is useful for applying updated rules, fixing style issues, or re-reviewing with a new checklist.

**If the hash differs** (dashboard has changed):

> "The dashboard has changed since the last run. Let me analyze what's different."

Proceed to Phase 2M.

---

## Phase 2M: Delta Extraction

Instead of a full extraction from scratch, run a delta-aware extraction that builds on the previous analysis.

### Sub-agent prompt template (delta mode)

```
You are analyzing a Grafana dashboard JSON export that has been UPDATED since the last guide generation. Your job is to identify what changed and update the extraction report.

**Read these reference files first:**
1. `.cursor/skills/autogen-guide-dashboard/dashboard-extraction-patterns.md`
2. `.cursor/skills/autogen-guide-dashboard/dashboard-selector-strategies.md`
3. `.cursor/skills/autogen-guide-dashboard/dashboard-guide-rules.md`

**Previous extraction report** (read this — it's your warm start):
{guide_dir}/assets/extraction-report.md

**Current dashboard JSON** (read this — it's the source of truth):
{guide_dir}/assets/dashboard-source.json

**Your task:**
1. Parse the current dashboard JSON fully (same as a fresh extraction)
2. Compare against the previous extraction report:
   - **Added panels**: panels in the current JSON not in the previous report
   - **Removed panels**: panels in the previous report not in the current JSON
   - **Modified panels**: panels where title, type, gridPos, queries, or variables changed
   - **Unchanged panels**: panels that match the previous report exactly
3. For added/modified panels: grade selectors, determine fold position, assign guide treatment
4. For removed panels: flag which guide sections are affected
5. Check for variable changes: new, removed, or renamed template variables
6. Check for row structure changes: added, removed, or reordered rows

**Write your results** to `{guide_dir}/assets/extraction-report.md` (overwrite the previous file).

Start the file with the standard frontmatter disclaimer, then use the same structure as a fresh extraction report BUT add a "Changes Since Last Run" section at the top:

### Changes Since Last Run
- **Added panels**: {count} ({list titles})
- **Removed panels**: {count} ({list titles})
- **Modified panels**: {count} ({list titles and what changed})
- **Unchanged panels**: {count}
- **Variable changes**: {list any added/removed/renamed variables}
- **Row structure changes**: {list any row additions/removals/reorders}

**Return** a brief summary: what changed, what's stable, and whether the existing guide sections are still viable.
```

### After delta extraction

Present the changes to the user:

> "The dashboard changed: 2 panels added, 1 removed, 3 modified, 8 unchanged. The existing guide has 3 sections; section 'resource-usage' is affected by the removed panel. How would you like to proceed?"

---

## Checkpoint M: Update the Guide Plan

Read the updated extraction report and the existing `{guide_dir}/assets/guide-plan.md`. Determine the minimal plan changes:

1. **Sections with only unchanged panels** → mark as "keep as-is" (no regeneration needed)
2. **Sections with modified panels** → mark as "regenerate" (the section sub-agent runs again)
3. **Sections with removed panels** → mark as "regenerate" (may need fewer steps or merging)
4. **New panels not covered by existing sections** → propose adding to an existing section or creating a new one

Write the updated plan to `{guide_dir}/assets/guide-plan.md` (overwrite). Add a "Maintenance Notes" section:

```markdown
### Maintenance Notes
- Sections kept as-is: {list section IDs}
- Sections to regenerate: {list section IDs and why}
- New sections proposed: {list, if any}
- Sections to remove: {list, if any}
```

Present the updated plan to the user for confirmation.

---

## Phase 3M: Selective Regeneration

Only regenerate sections marked as "regenerate" in the updated plan. For each such section, use the same per-section sub-agent prompt from SKILL.md Phase 3.2.

For sections marked "keep as-is", extract their JSON directly from the existing `content.json` and include them unchanged.

### Assembly

1. Read the existing `content.json`
2. For "keep as-is" sections: reuse the section JSON verbatim
3. For "regenerate" sections: replace with the new sub-agent output
4. For removed sections: omit them
5. For new sections: insert at the appropriate position
6. Re-run the noop-only section check (a modified section may now be all-noop)
7. Update the closing summary markdown if needed
8. Write the assembled `content.json`
9. Regenerate `{guide_dir}/assets/selector-report.md`

---

## Phase 4M: Review

Run the same Phase 4 review as SKILL.md, but add a maintenance-specific check to the tailored items:

```
**Drift verification** (maintenance run):
- Verify that sections marked "keep as-is" still have valid selectors (panel titles may have changed)
- Verify that regenerated sections reference the correct panel titles from the updated dashboard
- Verify that removed panels are not referenced anywhere in the guide
- Verify that new panels mentioned in noop/markdown blocks have correct titles
```

---

## Phase 5M: Update Manifest

Write an updated `{guide_dir}/assets/manifest.yaml` with:

- The new `generated_at` timestamp
- The new `source_sha256`
- Updated `sections`, `total_steps`, `selector_quality`

---

## Drift Risk Reference

Each analysis artifact has a different staleness risk when the dashboard changes:

| Artifact | Staleness signal | Reuse strategy |
|----------|-----------------|----------------|
| `dashboard-source.json` | Always re-fetch | Overwrite with current version |
| `extraction-report.md` | Dashboard hash changed | Re-run with delta mode; previous report is warm start |
| `guide-plan.md` | Extraction report changed | Amend for affected sections; don't rebuild from scratch |
| `selector-report.md` | Guide content changed | Always regenerate after any content.json edits |
| `content.json` | Plan or selectors changed | Only regenerate affected sections |

### Specific drift risks

- **Panel rename**: Selector `data-testid` changes → step targeting the old title breaks silently. The delta extraction catches this as a "modified panel."
- **Panel repositioned**: `gridPos.y` change can flip a panel from above-fold to below-fold (or vice versa), changing whether it needs `lazyRender`. The extraction flags fold changes.
- **Variable rename**: Panel titles with `$var` interpolation resolve differently. Content text referencing the old variable name becomes confusing.
- **Row restructure**: Row-scoped selectors may break if rows are added, removed, or reordered. The delta extraction flags row structure changes.
