name: Validate JSON Files

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  validate-recommender-rules:
    name: Validate Recommender Rules (index.json)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        persist-credentials: false
        submodules: false
      
    - name: Checkout validation scripts from main
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        ref: main
        sparse-checkout: |
          .github/scripts/
        sparse-checkout-cone-mode: false
        path: .github-trusted
        persist-credentials: false
      
    - name: Validate index.json
      run: |
        echo "Validating index.json for well-formed JSON..."
        
        # Check if index.json exists
        if [ ! -f "index.json" ]; then
          echo "‚ùå Error: index.json file not found"
          exit 1
        fi
        
        # Validate JSON using the validation script
        python3 .github-trusted/.github/scripts/validate_json.py index.json
        
        if [ $? -eq 0 ]; then
          echo "üéâ All validations passed! index.json is well-formed and properly structured."
        else
          echo "‚ùå JSON validation failed!"
          exit 1
        fi

  validate-guides:
    name: Validate Interactive Guides (content.json)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        persist-credentials: false
        submodules: false

    - name: Checkout pathfinder-app CLI
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        repository: grafana/grafana-pathfinder-app
        ref: main
        path: pathfinder-app
        persist-credentials: false

    - name: Setup Node.js
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: pathfinder-app/package-lock.json

    - name: Install dependencies
      working-directory: pathfinder-app
      run: npm ci

    - name: Build CLI
      working-directory: pathfinder-app
      run: npm run build:cli

    - name: Validate guides (content.json per-file)
      run: |
        echo "üîç Finding and validating content.json files..."
        echo ""
        
        PASSED=0
        FAILED=0
        
        # Find and iterate through each content.json file
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            echo "üìÑ Validating: $file"
            
            if node pathfinder-app/dist/cli/cli/index.js validate --strict "$file"; then
              PASSED=$((PASSED + 1))
            else
              echo "‚ùå Validation failed for: $file"
              echo ""
              FAILED=$((FAILED + 1))
            fi
          fi
        done < <(find . -name "content.json" -type f -not -path "./pathfinder-app/*")
        
        echo ""
        echo "üìä Validation Summary:"
        echo "  ‚úÖ Passed: $PASSED"
        echo "  ‚ùå Failed: $FAILED"
        
        if [ $FAILED -gt 0 ]; then
          echo ""
          echo "‚ùå $FAILED guide(s) failed validation!"
          exit 1
        else
          echo ""
          echo "üéâ All $PASSED guide(s) validated successfully!"
        fi

    - name: Validate packages (manifest.json directories)
      run: |
        echo "üîç Validating all package directories (those with manifest.json)..."
        echo ""
        node pathfinder-app/dist/cli/cli/index.js validate --packages .

    - name: Build repository.json
      run: |
        echo "üî® Generating repository.json from all packages..."
        echo ""
        node pathfinder-app/dist/cli/cli/index.js build-repository . -o repository.json
        echo ""
        echo "üì¶ repository.json generated successfully"

    - name: Build dependency graph (informational)
      continue-on-error: true
      run: |
        echo "üîó Building dependency graph..."
        echo ""
        node pathfinder-app/dist/cli/cli/index.js build-graph interactive-tutorials:repository.json

    - name: Upload repository.json and graph.json artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: repository-and-graph-json
        path: |
          repository.json
          graph.json
        retention-days: 30
