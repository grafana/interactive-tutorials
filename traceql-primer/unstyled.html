<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TraceQL Primer</title>
</head>
<body>
    <h1>A TraceQL Primer</h1>

    <p>Welcome to your TraceQL journey! In this interactive tutorial, you'll learn:</p>
    <ul>
        <li>How to navigate to the Explore page</li>
        <li>How to select the Tempo data source</li>
        <li>How to use the TraceQL query editor</li>
        <li>How to write and execute basic TraceQL queries</li>
        <li>How to explore trace results and view individual spans</li>
        <li>How to analyze trace details using the waterfall visualization</li>
    </ul>

    <p>By the end of this tutorial, you'll be able to query and investigate distributed traces using TraceQL!</p>

    <h2>Step 1: Navigate to Explore</h2>
    <p>The Explore page is where you can run ad-hoc queries and investigate your data. Let's start by opening it.</p>
    <p>It's perfect for running ad-hoc queries, investigating traces with TraceQL, analyzing logs with LogQL, and exploring metrics with PromQL - all without needing to create a dashboard.</p>
    <span id="navigate-to-explore" class="interactive" data-targetaction="sequence" data-reftarget="span#navigate-to-explore">
        <ul>
            <li class="interactive"
                data-requirements="navmenu-open"
                data-reftarget="a[data-testid='data-testid Nav menu item'][href='/explore']"
                data-targetaction='highlight'>
            Click <strong>Explore</strong> in the navigation menu.
            </li>
        </ul>
    </span>

    <h2>Step 2: Select the Tempo Data Source</h2>
    <p><strong>Tempo</strong> is Grafana's distributed tracing data source. It stores and queries traces from your applications, helping you understand request flows across microservices and identify performance bottlenecks.</span>We'll select it as our data source to query traces using TraceQL.</p>
    <span id="select-tempo" class="interactive" data-targetaction="sequence" data-reftarget="span#select-tempo" data-requirements="section-completed:navigate-to-explore,has-datasource:tempo">
        <ul>
            <li class="interactive" data-targetaction="multistep">
                <span class="interactive" data-targetaction="highlight" data-reftarget='input#data-source-picker'></span>
                <span class="interactive" data-targetaction="button" data-reftarget='Tempo'></span>
                Open the data source picker and select <strong>Tempo</strong>.
            </li>
        </ul>
    </span>

    <h2>Step 3: Select the TraceQL Tab</h2>
    <p>Tempo's query editor has multiple query modes. TraceQL is a powerful query language designed specifically for querying traces.</p>
    <span id="select-traceql-tab" class="interactive" data-targetaction="sequence" data-reftarget="span#select-traceql-tab" data-requirements="section-completed:select-tempo">
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='div[data-testid="data-testid radio-button"] label:contains("TraceQL")'>
            <span class="interactive-comment"><strong>TraceQL</strong> (Trace Query Language) is a powerful query language inspired by PromQL and LogQL. It lets you filter, aggregate, and analyze traces using familiar syntax with curly braces <code>{}</code> for filtering and pipes <code>|</code> for transformations.</span>
            Click the <strong>TraceQL</strong> tab to switch to the TraceQL query editor.
            </li>
        </ul>
    </span>

    <h2>Step 4: Enter Your First TraceQL Query</h2>
    <p>Let's start with the simplest TraceQL query: <code>{}</code>. This query returns all traces, similar to how <code>{}</code> works in PromQL and LogQL.</p>
    <span id="first-traceql-query" class="interactive" data-targetaction="sequence" data-reftarget="span#select-traceql-tab" data-requirements="section-completed:select-tempo">
        <ul>
            <li class="interactive"
                data-targetaction="formfill"
                data-reftarget='textarea[aria-label="Editor content;Press Alt+F1 for Accessibility Options."]'
                data-targetvalue='{ }'>
                Enter the following query into the query editor: <code>{}</code>. This query will return any traces where any of the spans match the span selector. In this case, the span selector is empty, so this matches any spans in any traces.
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='button[data-testid="data-testid RefreshPicker run button"]'>
                <span class="interactive-comment">Click the <strong>Run Query</strong> button to execute your query and see the results.</span>
                Click the <strong>Run Query</strong> button to execute your query and see the results.
            </li>
        </ul>
    </span>

    <h2>Step 5: Observe the Results</h2>
    <p>The results table shows you the traces that match your query. In this case, because we've entered <code>{}</code>, this matches any spans in any traces stored in Tempo (ie. any traces match the query!). Each trace shows the TraceID, the Start time of the root span, the root Service the root span belongs to, the name of the root span, and the duration of the root span. We can take a look at the returned matches spans for each trace by expanding the trace.</p>
    <span id="first-traceql-query" class="interactive" data-targetaction="sequence" data-reftarget="span#select-traceql-tab" data-requirements="section-completed:first-traceql-query">
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='div[title="Toggle Row Expanded"]:nth-match(1)'>
                Select the <strong>Expand</strong> button to expand the first trace.
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='a[data-testid="data-testid Data link"]:nth-match(1)'>
                Select the first <strong>Span</strong> link to visualise the trace in the trace visualisation panel.
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='button[role="switch"]:nth-match(1)'>
                Select the first <strong>span</strong> in the trace to expand it and view its intrinsics and attributes.
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='div[data-testid="AccordianKeyValues--header"]:nth-match(1)'>
                Select the <strong>Span attributes</strong> attributes to view the span attributes for the first span. These attributes are specific to the span and are set by the application and the instrumentation library, showing the context of the span itself and the work that it represents.
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='div[data-testid="AccordianKeyValues--header"]:nth-match(2)'>
                Select the <strong>Resource attributes</strong> attributes to view the attributes for the first span. Resource attributes are attributes that are set by the infrastructure and are used to identify the resource that the span is associated with (such as the version of the service, the host it ran on, the OS type and version, etc.).
            </li>
        </ul>
        <ul>
            <li id="close-trace-visualisation-panel" class="interactive" data-targetaction="multistep">
                <span class="interactive"
                    data-targetaction="highlight"
                    data-reftarget='button[aria-label="Show more items"]:nth-match(2)'></span>
                <span class="interactive"
                    data-targetaction="highlight"
                    data-reftarget='button[aria-label="Close split pane"]:nth-match(3)'></span>
                Finally close the trace visualisation panel by selecting the elipses at the top right of the panel, and then selecting the <Strong>Close</Strong> button.
            </li>
        </ul>
        </span>
    </span>


    <h2>Step 6: Write a useful TraceQL query</h2>
    <p>The query we just wrote will find all traces and spans, which is not very useful. The `{}` is a span selector, essentially a filter that informs Grafana Tempo the traces and spans to return that match that filter. For example, let's find spans that belong to the `productcatalog` service. We can do this by writing a span selector that uses the <code>resource.service.name</code> resource attribute to tell Tempo to return only spans in traces which were generated by the `frontend` service.</p>
    <span id="first-traceql-query" class="interactive" data-targetaction="sequence" data-reftarget="span#select-traceql-tab" data-requirements="section-completed:select-tempo">
        <ul>
            <li class="interactive"
                data-targetaction="formfill"
                data-reftarget='textarea[aria-label="Editor content;Press Alt+F1 for Accessibility Options."]'
                data-targetvalue='{ resource.service.name = "frontend" }'>
                Enter the following query into the query editor:
                <p><code>{ resource.service.name = "frontend" }</code></p>
                This query will return any traces where any of the spans were generated by the `frontend` service.
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='button[data-testid="data-testid RefreshPicker run button"]'>
                <span class="interactive-comment">Click the <strong>Run Query</strong> button to execute your query and see the results.</span>
                Click the <strong>Run Query</strong> button to execute your query and see the results.
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='div[title="Toggle Row Expanded"]:nth-match(1)'>
                Select the <strong>Expand</strong> button to expand the first trace. This shows the matching spans that exist in the trace (note that there may be one or two, or more).
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='div[aria-label="table header"]:nth-match(3)'
                data-doit="false"
                data-showme-text="Matching span characteristics">
                The matching spans have a <strong>resource.service.name</strong> attribute value of <strong>frontend</strong>. You can visualise this trace again, by selecting the <string>Span ID</string>strong> or th <strong>Trace ID></strong> for this trace (if you do so, remember to close the trace visualisation panel before continuing!).
            </li>
        </ul>
    </span>

    <h2>Step 7: Understand query options</h2>
    <p>Something you may have noticed is that we only saw a set of twenty matching traces returned in the list from our query. This is because Tempo will return the first twenty matching traces it finds that include spans matching the span selector. We can change this by using the <code>Search Options</code> available as part of the query editor.</p>.
    <span id="first-traceql-query" class="interactive" data-targetaction="sequence" data-reftarget="span#select-traceql-tab" data-requirements="section-completed:select-tempo">
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='div:contains("Search Options")'>
                Expanding the <code>Search Options</code> section will show you the available options. You can change the number of traces return by Tempo by altering the <strong>Limit</strong> value. You can alter the maximum number of matching spans returned for each trace by altering the <strong>Span Limit</strong> value. You can also alter the format of the results returned by toggling between <strong>Traces</strong> and <strong>Spans</strong> under the <strong>Table Format</strong> section. Also note the <strong>Metrics Options</strong> section. For now, we'll update the returned traces and spans per trace to 50 and 10, respectively.
            </li>
            <li class="interactive"
                data-targetaction="formfill"
                data-reftarget='input[data-testid="autosize-input"]:nth-match(1)'
                data-targetvalue='50'>
                Enter <strong>50</strong> for the <strong>Limit</strong> value.
            </li>
            <li class="interactive"
                data-targetaction="formfill"
                data-reftarget='input[data-testid="autosize-input"]:nth-match(2)'
                data-targetvalue='10'>
                Enter <strong>10</strong> for the <strong>Span Limit</strong> value.
            </li>
            <ul>
                <li class="interactive"
                    data-targetaction="formfill"
                    data-reftarget='textarea[aria-label="Editor content;Press Alt+F1 for Accessibility Options."]'
                    data-targetvalue='{ span:kind = server } | count() > 3'>
                    Enter the following query into the query editor:
                    <p><code>{ span:kind = server } | count() > 3</code>.</p>
                    This query:
                    <ul>
                        <li>Uses <code>span:kind</code> which is a span intrinsic. This looks for any span which has a span kind of <strong>server</strong>, which denotes a span as receiving a request from an upstream client (which would make it a distributed trace).</li>
                        <li>Uses the pipe symbol (<code>|</code>) to pipe the results of the first query into the second query.</li>
                        <li>Uses the <code>count()</code> function to count the number of spans that match the characteristics of the span selector. In this case, we only want to returns traces where four or more spans have the <strong>server</strong> span kind. This essentially denotes a distributed trace that has at least calls to four or more services.</li>
                    </ul>
                </li>
            </ul>
            <ul>
                <li class="interactive"
                    data-targetaction="highlight"
                    data-reftarget='button[data-testid="data-testid RefreshPicker run button"]'>
                    <span class="interactive-comment">Click the <strong>Run Query</strong> button to execute your query and see the results.</span>
                    Click the <strong>Run Query</strong> button to execute your query and see the results.
                </li>
            </ul>
            <ul>
                <li class="interactive"
                    data-targetaction="highlight"
                    data-reftarget='div[title="Toggle Row Expanded"]:nth-match(1)'>
                    Select the <strong>Expand</strong> button to expand the first trace. Note the <strong>count()</strong> and <code>span:kind</code> values the colums for the returned spans. This shows us the matches from our query..
                </li>
            </ul>
            <ul>
                <li class="interactive"
                    data-targetaction="highlight"
                    data-reftarget='a[data-testid="data-testid Data link"]:nth-match(1)'>
                    Select the first <strong>Span</strong> link in the first trace to visualise the trace in the trace visualisation panel. The link will open the trace at the span you selected. Note that this trace shows a detailed hierarchy of services calling other service.
                </li>
            </ul>
        </ul>
        <ul>
            <li id="close-trace-visualisation-panel" class="interactive" data-targetaction="multistep">
                <span class="interactive"
                    data-targetaction="highlight"
                    data-reftarget='button[aria-label="Show more items"]:nth-match(2)'></span>
                <span class="interactive"
                    data-targetaction="highlight"
                    data-reftarget='button[aria-label="Close split pane"]:nth-match(3)'></span>
                Finally close the trace visualisation panel by selecting the elipses at the top right of the panel, and then selecting the <Strong>Close</Strong> button.
            </li>
        </ul>
    </span>

    <h2>Step 8: Try a TraceQL Metrics Query</h2>
    <p>TraceQL doesn't just allow you to find interesting traces and return them as a table of matching traces. It also includes a powerful set of metrics functions that can be used to aggregate the results of a query. You can use these functions to convert the results to time-series data, that can then be visualised as graphs, heatmaps, tables or any other type of visualisation that Grafana supports for time-series data. Much like the way our last query used pipelining to filter the span selectors into the <code>count()</code> function, we can also pipeline results into metrics functions to aggregate the results. Let's try a simple metrics query to count the number of traces that match our query.</p>
    <span id="first-traceql-metrics-query" class="interactive" data-targetaction="sequence" data-reftarget="span#select-traceql-tab" data-requirements="section-completed:select-tempo">
        <ul>
            <li class="interactive"
                data-targetaction="formfill"
                data-reftarget='textarea[aria-label="Editor content;Press Alt+F1 for Accessibility Options."]'
                data-targetvalue='{ span:kind = server && resource.service.name !~ "frontend|flagd" } | count_over_time() by (resource.service.name, span:name)'>
                Enter the following query into the query editor:
                <p><code>{ span:kind = server && resource.service.name !~ "frontend|flagd" } | count_over_time() by (resource.service.name, span:name)</code></p>
                This query:
                <ul>
                    <li>Uses the <code>span:kind</code> intrinsic to match on any span in any of our traces that are of kind <strong>server</strong>.</li>
                    <li>Uses the <code>resource.service.name</code> attribute to match on any span in any of our traces that are not from the <strong>frontend</strong> or <strong>flagd</strong> services, using the negated regex operator (<code>!~</code>).</li>
                    <li>Pipes the results into the <code>count_over_time()</code> function, which counts the number of spans in each time window</li>
                    <li>Groups the results by the service name and span name (ie. the number of spans for each service and span name)</li>
                    <li>Converts the results to time-series data</li>
                </ul>
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='button[data-testid="data-testid RefreshPicker run button"]'>
                Select the <strong>Run Query</strong> button or enter <kbd>Shift</kbd>+<kbd>Enter</kbd> to execute your query and see the results.
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='label:contains("Bars"):nth-match(1)'>
                The time-series is rendered by default as a line graph showing the count of the spans aggregated by service and span name, for all spans that of are kind <strong>server</strong>. You can change the visualisation to a different type of graph by selecting the format you want in the top-right. Try now by selecting <strong>Bars</strong>.
            </li>
        </ul>
        <ul>
            <li class="interactive"
                data-targetaction="highlight"
                data-reftarget='label:contains("Points"):nth-match(1)'>
                You can select any of the other visualisation formats to see how the data is rendered in a different way. Now try selecting <strong>Points</strong>.
            </li>
        </ul>
    </span>

    <h2>ðŸŽ‰ Congratulations!</h2>
    <p>Excellent work! You've successfully queried and explored traces using TraceQL. You now know:</p>
    <ul>
        <li>âœ… How to navigate to the Explore page</li>
        <li>âœ… How to select the Tempo data source</li>
        <li>âœ… How to switch to the TraceQL query editor</li>
        <li>âœ… How to write and execute a basic TraceQL query</li>
        <li>âœ… How to select a trace and span in the results list to visualise a trace</li>
        <li>âœ… How to expand a span in a visualised trace to see its intrinsics and attributes</li>
        <li>âœ… How to build a TraceQL query with span selectors for specific span characteristics</li>
        <li>âœ… How to change the search options to return more or less traces and spans</li>
        <li>âœ… How to build a TraceQL query with pipelining and functions to aggregate the results</li>
        <li>âœ… How to run a TraceQL metrics query to count the number of spans in each time window</li>
        <li>âœ… How to change the visualisation of the metrics query results</li>
    </ul>

    <h3>What's Next?</h3>
    <p>Now that you've run your first TraceQL query, here are some next steps:</p>
    <ul>
        <li><strong>Filter by duration</strong> - Use <code>{duration > 1s}</code> to find slow traces</li>
        <li><strong>Filter by status</strong> - Try <code>{span:status=error}</code> to find failed requests</li>
        <li><strong>Combine filters</strong> - Use <code>{service.name="api" && status=error}</code> for complex queries</li>
        <li><strong>Explore span attributes</strong> - Query specific span attributes like <code>{span.http.method="POST"}</code></li>
    </ul>

    <p><strong>You're now ready to explore your distributed traces!</strong> TraceQL gives you powerful querying capabilities to understand your application's behavior.</p>
</body>
</html>

